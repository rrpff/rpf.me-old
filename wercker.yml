box: nodesource/trusty:4.1.0

dev:
  steps:
    - script:
        name: export environment variables
        code: |
          export NODE_ENV='development'
          export PORT=5000
    - npm-install
    - internal/watch:
        code: npm start
        reload: true

build:
  steps:
    - script:
        name: export environment variables
        code: |
          export NODE_ENV='development'
          export PORT=5000
    - npm-install
    - npm-test
    - script:
        name: print versions
        code: |
          echo "node version $(node -v)"
          echo "npm version $(npm -v)"

deploy:
  default: &defaults
    - install-packages:
        packages: openssh-client rsync
    - add-to-known_hosts:
        hostname: 178.62.17.220
        local: true
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DIGITAL_OCEAN_PRIVATE
        overwrite: true
        hide-from-log: true
    - sjoerdmulder/rsync-deploy:
        host: 178.62.17.220
        user: root
        directory: $APP_PATH
        sshkey: $PRIVATEKEY_PATH
    - script:
        name: npm install
        code: |
          ssh -i $PRIVATEKEY_PATH \
              -l root \
              -o UserKnownHostsFile=/dev/null \
              -o StrictHostKeyChecking=no \
              root@178.62.17.220 \
              "cd $APP_PATH && npm install --production"
    - script:
        name: start app
        code: |
          ssh -i $PRIVATEKEY_PATH \
              -l root \
              -o UserKnownHostsFile=/dev/null \
              -o StrictHostKeyChecking=no \
              root@178.62.17.220 \
              "cd $APP_PATH && \
               pm2 stop rpf.me -s && \
               pm2 start dist/app/index.js --name rpf.me -i 2"

  production:
    <<: &defaults
